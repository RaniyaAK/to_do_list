{% extends "master.html" %}
{% load static %}

{% block title %}To Do List{% endblock %}

{% block content %}

<!-- Theme toggle button (only here) -->
<div class="container">
    <button id="themeToggle" class="theme-toggle">üåô</button>
</div>

<div class="container">
    <h1>To Do List</h1>
</div>

<div class="add_button container">
    <button class="add_btn"><a href="/add">+ Add Tasks</a></button>
</div>

<div class="container">
    <table id="taskTable">
        <thead>
            <tr>
                <th>No.</th>
                <th>Date</th>
                <th>Task</th>
                <th>Status</th>
                <th>Due Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for x in mytasks %}
        <tr data-id="{{ x.id }}" draggable="true">
            <td>{{ x.id }}</td>
            <td>{{ x.created_date }}</td>
            <td>{{ x.task }}</td>

            {% if x.status == "pending" %}
            <td class="pending_btn">{{ x.status }}</td>
            {% else %}
            <td class="completed_btn">{{ x.status }}</td>
            {% endif %}

            <td>
                {{ x.due_date }}
                {% if x.status != "completed" %}
                    {% if x.due_date|date:"Y-m-d" == today|date:"Y-m-d" %}
                        <span class="due-today">Due Today</span>
                    {% elif x.due_date|date:"Y-m-d" < today|date:"Y-m-d" %}
                        <span class="overdue">Overdue</span>
                    {% else %}
                        <span class="pending">Pending</span>
                    {% endif %}
                {% endif %}
            </td>

            <td>
                <button class="update_btn"><a href="update_tasks/{{x.id}}">Update</a></button>
                <button class="delete_btn"><a href="delete/{{x.id}}">Delete</a></button>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>


<!-- Theme toggle JS -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const body = document.body;
    const toggleButton = document.getElementById('themeToggle');

    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if(savedTheme){
        body.classList.remove('light-theme','dark-theme');
        body.classList.add(savedTheme);
        toggleButton.textContent = savedTheme === 'dark-theme' ? '‚òÄÔ∏è' : 'üåô';
    }

    toggleButton.addEventListener('click', () => {
        body.classList.toggle('dark-theme');
        body.classList.toggle('light-theme');

        const currentTheme = body.classList.contains('dark-theme') ? 'dark-theme' : 'light-theme';
        localStorage.setItem('theme', currentTheme);

        toggleButton.textContent = currentTheme === 'dark-theme' ? '‚òÄÔ∏è' : 'üåô';
    });
});
</script>


<!-- ‚úÖ Drag & Drop Script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const tbody = document.querySelector("#taskTable tbody");
    let draggedRow = null;

    tbody.addEventListener("dragstart", (e) => {
        if (e.target.tagName === "TR") {
            draggedRow = e.target;
            e.target.classList.add("dragging");
        }
    });

    tbody.addEventListener("dragend", (e) => {
        if (e.target.tagName === "TR") {
            e.target.classList.remove("dragging");
            draggedRow = null;
        }
    });

    tbody.addEventListener("dragover", (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(tbody, e.clientY);
        if (afterElement == null) {
            tbody.appendChild(draggedRow);
        } else {
            tbody.insertBefore(draggedRow, afterElement);
        }
    });

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll("tr[draggable]:not(.dragging)")];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
});
</script>

{% endblock %}
